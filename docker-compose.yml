services:
    nginx:
        image: nginx:1.27-alpine
        container_name: dev-nginx
        ports:
            - "8080:80"
        volumes:
            - ./nginx/conf.d:/etc/nginx/conf.d:ro
        depends_on:
            - backend
            - frontend
        networks:
            - devnet

    backend:
        build:
            context: ./backend
        container_name: dev-backend
        environment:
            - DATABASE_HOST=mysql
            - DATABASE_PORT=3306
            - DATABASE_NAME=${MYSQL_DATABASE}
            - DATABASE_USER=${MYSQL_USER}
            - DATABASE_PASSWORD=${MYSQL_PASSWORD}
            - REDIS_HOST=redis
            - REDIS_PORT=6379
        volumes:
            - ./backend:/app
        command: >
            sh -c "uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"
        depends_on:
            mysql:
                condition: service_healthy
            redis:
                condition: service_healthy
        networks:
            - devnet

    frontend:
        image: node:22-alpine
        container_name: dev-frontend
        working_dir: /work
        volumes:
            - ./frontend:/work
            - frontend_node_modules:/work/node_modules
        environment:
            - CHOKIDAR_USEPOLLING=true
        command: >
            sh -c "npm ci && npm run dev -- --host 0.0.0.0 --port 5173"
        ports:
            - "5173:5173"
        networks:
            - devnet

    mysql:
        image: mysql:8.4
        container_name: dev-mysql
        ports:
            - "3306:3306"
        environment:
            - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
            - MYSQL_DATABASE=${MYSQL_DATABASE}
            - MYSQL_USER=${MYSQL_USER}
            - MYSQL_PASSWORD=${MYSQL_PASSWORD}
            - TZ=Asia/Seoul
        volumes:
            - mysql_data:/var/lib/mysql
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-p${MYSQL_ROOT_PASSWORD}"]
            interval: 5s
            timeout: 3s
            retries: 30
        networks:
            - devnet

    redis:
        image: redis:7-alpine
        container_name: dev-redis
        ports:
            - "6379:6379"
        volumes:
            - redis_data:/data
        command: ["redis-server", "--appendonly", "yes"]
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 5s
            timeout: 3s
            retries: 30
        networks:
            - devnet

    py:
        image: python:3.12-slim
        container_name: dev-py
        working_dir: /work
        volumes:
            - ./python-scratch:/work
        command: ["sleep", "infinity"]
        networks:
            - devnet

volumes:
    mysql_data:
    frontend_node_modules:
    redis_data:

networks:
    devnet:
        driver: bridge